@inherits FullComponentBase

<MudTabPanel Class="open-sans-600" Text="@Title">
    <MudContainer MaxWidth="MaxWidth.ExtraLarge">
        <MudGrid Class="mt-8" Justify="Justify.Center">
            <MudItem xs="12">
                <MudDataGrid @ref="_grid" T="AbstractSkillModel" ServerData="@(async(state) => await GetModelsAsync(state))" Bordered Hover Outlined Filterable Striped SortMode="SortMode.Multiple" Dense FixedHeader
                             Culture="@(new CultureInfo("fr-FR"))" Height="70vh" Virtualize OverscanCount="5" ItemSize="39" RowClick="@OnRowClickedAsync">
                    <ToolBarContent>
                        <MudText Class="open-sans-600" Style="font-weight: bold!important">Actions</MudText>
                        <MudTooltip Class="ml-2" Placement="Placement.Bottom" Text="Purge des compétences" Arrow>
                            <MudIconButton Class="ml-4 hover-red" Style="border-radius: 6px!important; padding: 4px!important;" Icon="@IconsF.Delete" Color="@(ThemeManager.IsDarkTheme ? Color.Default : Color.Dark)" OnClick="@(() => PurgeSkillsAsync())"/>
                        </MudTooltip>
                        <MudTooltip Class="ml-2" Placement="Placement.Top" Text="Importer des compétences" Arrow>
                            <MudIconButton Class="ml-4" Style="border-radius: 6px!important; padding: 4px!important;" Icon="@IconsFF.FileExcel" Color="Color.Tertiary" OnClick="@(() => ImportSkillsAsync())"/>
                        </MudTooltip>
                        <MudTooltip Class="ml-2" Placement="Placement.Bottom" Text="Créer une compétence" Arrow>
                            <MudIconButton Class="ml-4" Style="border-radius: 6px!important; padding: 4px!important;" Icon="@IconsF.AccountTree" Color="Color.Tertiary" OnClick="@(() => CreateSkillAsync())"/>
                        </MudTooltip>
                        <MudTooltip Class="ml-2" Placement="Placement.Top" Text="Créer un soft-skill" Arrow>
                            <MudIconButton Class="ml-4" Style="border-radius: 6px!important; padding: 4px!important;" Icon="@IconsF.Handshake" Color="Color.Tertiary" OnClick="@(() => CreateSoftSkillAsync())"/>
                        </MudTooltip>
                        <MudTooltip Placement="Placement.Right" Text="Pour éditer, faites un double clic sur une ligne !" Arrow>
                            <MudIcon Class="ml-5 mt-1" Icon="@IconsF.Info" Color="Color.Info"/>
                        </MudTooltip>
                        <MudSpacer/>
                        <MudTextField T="string" @bind-Value="_search" OnBlur="@(async() => await RefreshDataAsync())" Immediate Adornment="Adornment.Start" Clearable
                                      AdornmentIcon="@IconsF.Search" Placeholder="Rechercher" Class="flex-grow-0 mr-8 mt-0" Style="width: 400px;"/>
                    </ToolBarContent>
                    <Columns>
                        <HierarchyColumn T="AbstractSkillModel"/>
                        <PropertyColumn Title="Type" Property="x => x.Type"/>
                        <PropertyColumn Title="Catégorie" Property="x => x.Category"/>
                        <TemplateColumn Title="Sous catégorie">
                            <CellTemplate>
                                <MudText Typo="Typo.body2">@(context.Item.SubCategory ?? string.Empty)</MudText>
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Title="Description" Property="x => x.Description"/>
                        <TemplateColumn Title="Actions" Sortable="false" Filterable="false">
                            <CellTemplate Context="row">
                                <MudStack Row Justify="Justify.SpaceEvenly">
                                    <MudTooltip Placement="Placement.Bottom" Text="Éditer" Arrow>
                                        <MudIconButton Icon="@IconsF.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(() => EditModelAsync(row.Item))"/>
                                    </MudTooltip>
                                    <MudTooltip Class="ml-2" Placement="Placement.Bottom" Text="Supprimer" Arrow>
                                        <MudIconButton Class="ml-4" Icon="@IconsF.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => DeleteSkillAsync(row.Item))"/>
                                    </MudTooltip>
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                    <ChildRowContent>
                        <MudStack Row="false" Spacing="0">
                            <MudText Style="font-weight: bold;" GutterBottom>Niveaux</MudText>
                            <MudStack Class="px-2" Row="false" Spacing="0">
                                @if (_skillTypeLevels[context.Item.Id].Any())
                                {
                                    @foreach (var typeLevel in _skillTypeLevels[context.Item.Id].OrderBy(x => x.Level))
                                    {
                                        <MudStack Row Justify="Justify.FlexStart">
                                            <MudText Class="open-sans-600" Typo="Typo.body2"><MudChip Size="Size.Small" Style="font-weight: bold!important;">@typeLevel.Level</MudChip> @typeLevel.Value</MudText>
                                        </MudStack>
                                    }
                                }
                                else if (_softSkillTypeLevels[context.Item.Id].Any())
                                {
                                    @foreach (var typeLevel in _softSkillTypeLevels[context.Item.Id].OrderBy(x => x.Level))
                                    {
                                        <MudStack Row Justify="Justify.FlexStart">
                                            <MudText Class="open-sans-600" Typo="Typo.body2"><MudChip Size="Size.Small" Style="font-weight: bold!important;">@typeLevel.Level</MudChip> @typeLevel.Value</MudText>
                                        </MudStack>
                                    }
                                }
                                else
                                {
                                    <MudAlert Class="mb-1" Severity="Severity.Normal">Aucun niveau défini pour ce type de compétence.</MudAlert>
                                }
                            </MudStack>
                        </MudStack>
                    </ChildRowContent>
                </MudDataGrid>
            </MudItem>
        </MudGrid>
    </MudContainer>
</MudTabPanel>

<PageLoading IsVisible="@_loading" />