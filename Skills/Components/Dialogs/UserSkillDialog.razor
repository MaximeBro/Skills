@using Microsoft.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore.Metadata.Conventions
@using Skills.Databases

<MudDialog>
    <DialogContent>
        <MudStack Class="py-3 px-6" Justify="Justify.SpaceEvenly" Row="false" Spacing="0">
            <MudText Class="mark-one" GutterBottom>Attribution de compétence</MudText>
            <MudStack Class="px-4" Justify="Justify.SpaceEvenly" Row="false" Spacing="0">
                <MudSelect T="Guid" ValueChanged="@SelectedSkillChanged" Value="_selectedSkill" ToStringFunc="@SkillToString" Style="min-width: 450px!important;" Label="Compétence"
                           AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft" Required>
                    @foreach (var skill in _skills)
                    {
                        <MudSelectItem Value="skill.Id">
                            <MudStack Row="false" Spacing="0">
                                <MudText Class="mark-one">
                                    @skill.ToStringNoDesc()
                                    <MudText Class="mark-one" Typo="Typo.body2">@skill.Description</MudText>
                                </MudText>
                            </MudStack>
                        </MudSelectItem>
                    }
                </MudSelect>
                @if (_isSoftSkill)
                {
                    <MudSelect T="int" @bind-Value="_selectedLevel" Label="Niveau" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft" Class="mt-4 c-select" Required>
                        <MudSelectItem Value="0"><MudChip>0</MudChip> @(_bindedSoftLevels.FirstOrDefault(x => x.Level == 0)?.Value ?? string.Empty)</MudSelectItem>
                        <MudSelectItem Value="1"><MudChip>1</MudChip> @(_bindedSoftLevels.FirstOrDefault(x => x.Level == 1)?.Value ?? string.Empty)</MudSelectItem>
                        <MudSelectItem Value="2"><MudChip>2</MudChip> @(_bindedSoftLevels.FirstOrDefault(x => x.Level == 2)?.Value ?? string.Empty)</MudSelectItem>
                        <MudSelectItem Value="3"><MudChip>3</MudChip> @(_bindedSoftLevels.FirstOrDefault(x => x.Level == 3)?.Value ?? string.Empty)</MudSelectItem>
                        <MudSelectItem Value="4"><MudChip>4</MudChip> @(_bindedSoftLevels.FirstOrDefault(x => x.Level == 4)?.Value ?? string.Empty)</MudSelectItem>
                    </MudSelect>
                }
                else
                {
                    <MudSelect T="int" @bind-Value="_selectedLevel" Label="Niveau" AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft" Class="mt-4 c-select" Required>
                        <MudSelectItem Value="0"><MudChip>0</MudChip> @(_bindedLevels.FirstOrDefault(x => x.Level == 0)?.Value ?? string.Empty)</MudSelectItem>
                        <MudSelectItem Value="1"><MudChip>1</MudChip> @(_bindedLevels.FirstOrDefault(x => x.Level == 1)?.Value ?? string.Empty)</MudSelectItem>
                        <MudSelectItem Value="2"><MudChip>2</MudChip> @(_bindedLevels.FirstOrDefault(x => x.Level == 2)?.Value ?? string.Empty)</MudSelectItem>
                        <MudSelectItem Value="3"><MudChip>3</MudChip> @(_bindedLevels.FirstOrDefault(x => x.Level == 3)?.Value ?? string.Empty)</MudSelectItem>
                        <MudSelectItem Value="4"><MudChip>4</MudChip> @(_bindedLevels.FirstOrDefault(x => x.Level == 4)?.Value ?? string.Empty)</MudSelectItem>
                    </MudSelect>
                }
                <style>
                    .c-select .mud-input-root-text {
                        display: flex!important;
                        align-items: center!important;
                        padding-top: 9px!important;
                        padding-bottom: 11px!important;
                    }
                </style>
            </MudStack>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Class="mark-one" Color="Color.Success" Variant="Variant.Text" OnClick="@Submit">Enregistrer</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public MudDialogInstance Dialog { get; set; } = null!;
    [Inject] public IDbContextFactory<SkillsContext> Factory { get; set; } = null!;
    [Inject] public ISnackbar Snackbar { get; set; } = null!;
    
    [Parameter] public UserSkillModel? UserSkill { get; set; }

    private int _selectedLevel = 0;
    private List<AbstractSkillModel> _skills = new();
    private Guid _selectedSkill;
    private List<TypeLevel> _bindedLevels = new();
    private List<SoftTypeLevel> _bindedSoftLevels = new();

    private bool _isSoftSkill = false;

    private Func<Guid, string> SkillToString => x =>
    {
        var skill = _skills.FirstOrDefault(y => y.Id == x);
        if (skill is null) return string.Empty;

        return skill.ToString();
    };

    private async Task SelectedSkillChanged(Guid skillId)
    {
        _selectedSkill = skillId;
        await RefreshLevelsAsync(skillId);
        await RefreshIsSoftSkillAsync(skillId);
    }

    private async Task RefreshIsSoftSkillAsync(Guid skillId)
    {
        var db = await Factory.CreateDbContextAsync();
        _isSoftSkill = db.SoftSkills.AsNoTracking().Select(x => x.Id).Contains(skillId);
        await db.DisposeAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        var db = await Factory.CreateDbContextAsync();
        var skills = await db.Skills.AsNoTracking()
                                 .Include(x => x.TypeInfo)
                                 .Include(x => x.CategoryInfo)
                                 .Include(x => x.SubCategoryInfo)
                                 .ToListAsync();
        
        var softSkills = await db.SoftSkills.AsNoTracking()
            .Include(x => x.TypeInfo)
            .ToListAsync();

        foreach (var model in softSkills) model.Type = model.TypeInfo.Value;
        foreach (var model in skills)
        {
            model.Type = model.TypeInfo.Value;
            model.Category = model.CategoryInfo.Value;
            model.SubCategory = model.SubCategoryInfo?.Value ?? string.Empty;
        }

        _skills.AddRange(new List<AbstractSkillModel>(skills));
        _skills.AddRange(new List<AbstractSkillModel>(softSkills));
        
        if (UserSkill != null)
        {
            _selectedSkill = UserSkill.SkillId;
            _selectedLevel = UserSkill.Level;
        }
        
        await db.DisposeAsync();
        await RefreshLevelsAsync(_selectedSkill);
        await RefreshIsSoftSkillAsync(_selectedSkill);
    }

    private async Task RefreshLevelsAsync(Guid skillId)
    {
        var typeId = _skills.FirstOrDefault(x => x.Id == skillId)?.TypeId ?? default(Guid);
        var db = await Factory.CreateDbContextAsync();
        _bindedLevels = db.TypesLevels.AsNoTracking().Where(x => x.TypeId == typeId).ToList();
        _bindedSoftLevels = db.SoftTypesLevels.AsNoTracking().Where(x => x.SkillId == skillId).ToList();
        await db.DisposeAsync();
        StateHasChanged();
    }

    private void Submit() 
    {
        if (_selectedSkill == Guid.Empty)
        {
            Snackbar.Add("Vous devez sélectionner une compétence !", Severity.Error);
            return;
        }
        
        Dialog.Close(new UserSkillModel { SkillId = _selectedSkill, Level = _selectedLevel });
    }
}