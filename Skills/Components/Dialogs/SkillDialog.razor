@using Microsoft.EntityFrameworkCore

<MudDialog>
    <DialogContent>
        <MudIconButton Class="ml-n4" Icon="@IconsF.Close" Color="Color.Dark" OnClick="@(() => Dialog.Close())" />
        <MudStack Class="px-4 py-2" Justify="Justify.SpaceEvenly" Row="false" Spacing="0">
            <MudStack Row Justify="Justify.Center">
                <MudSelect T="SKillInfo?" @bind-Value="_selectedType" Label="Type" Required Style="min-width: 220px;" ToStringFunc="@(skill => skill?.Value ?? string.Empty)"
                           AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                    @foreach (var type in _types)
                    {
                        <MudSelectItem Value="type">@type.Value</MudSelectItem>
                    }
                </MudSelect>

                <MudSelect T="SKillInfo?" @bind-Value="_selectedCategory" Label="Catégorie" Required Style="min-width: 220px;" ToStringFunc="@(skill => skill?.Value ?? string.Empty)"
                           AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                    @foreach (var category in _categories)
                    {
                        <MudSelectItem Value="category">@category.Value</MudSelectItem>
                    }
                </MudSelect>
            </MudStack>
            
            <MudStack Class="mt-4" Row Justify="Justify.Center">
                <MudSelect T="SKillInfo?" @bind-Value="_selectedSubCategory" Label="Sous catégorie" Style="min-width: 220px;" ToStringFunc="@(skill => skill?.Value ?? string.Empty)"
                           AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                    @foreach (var subcategory in _subcategories)
                    {
                        <MudSelectItem Value="subcategory">@subcategory.Value</MudSelectItem>
                    }
                </MudSelect>
                
                <MudTextField T="string" @bind-Value="_desc" Label="Description" Style="min-width: 220px;" />
            </MudStack>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Class="open-sans-600" Color="Color.Success" Variant="Variant.Filled" OnClick="@Submit">Enregistrer</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] public MudDialogInstance Dialog { get; set; } = null!;

    [Inject] public IDbContextFactory<SkillsContext> Factory { get; set; } = null!;
    [Inject] public ISnackbar Snackbar { get; set; } = null!;
    [Parameter] public SkillModel? Model { get; set; }

    private List<SKillInfo> _types = new();
    private List<SKillInfo> _categories = new();
    private List<SKillInfo> _subcategories = new();

    private SKillInfo? _selectedType;
    private SKillInfo? _selectedCategory;
    private SKillInfo? _selectedSubCategory;

    private string _desc = string.Empty;
    
    protected override async Task OnInitializedAsync()
    {
        var db = await Factory.CreateDbContextAsync();
        _types = db.SkillsTypes.AsNoTracking().Where(x => x.Type == SkillDataType.Type && x.Value != "SOFT-SKILL").ToList();
        _categories = db.SkillsTypes.AsNoTracking().Where(x => x.Type == SkillDataType.Category).ToList();
        _subcategories = db.SkillsTypes.AsNoTracking().Where(x => x.Type == SkillDataType.SubCategory).ToList();

        if (Model != null)
        {
            _selectedType = Model.TypeInfo;
            _selectedCategory = Model.CategoryInfo;
            _selectedSubCategory = Model.SubCategoryInfo;
            _desc = Model.Description ?? string.Empty;
        }
    }

    private void Submit()
    {
        if (_selectedType is null || _selectedCategory is null)
        {
            Snackbar.Add("Vous devez au moins sélectionner un type et une catégorie !", Severity.Error);
            return;
        }
        
        var skill = new SkillModel
        {
            TypeId = _selectedType.Id,
            Type = _selectedType.Value,
            CategoryId = _selectedCategory.Id,
            Category = _selectedCategory.Value,
            Description = _desc
        };
        
        if (_selectedSubCategory != null)
        {
            skill.SubCategoryId = _selectedSubCategory.Id;
            skill.SubCategory = _selectedSubCategory.Value;
        }

        Dialog.Close(skill);
    }
}